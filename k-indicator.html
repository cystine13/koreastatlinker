<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Korea Indicator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f9f9f9;
        }

        .container {
            max-width: 1280px;
            margin: 20px auto;
            padding: 20px;
            background-color: white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }

        .tabs {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            border-bottom: 2px solid #ccc;
        }

        .tab {
            padding: 12px 24px;
            cursor: pointer;
            background-color: #f9f9f9;
            border-radius: 4px 4px 0 0;
            font-size: 16px;
        }

        .tab.active {
            background-color: white;
            font-weight: bold;
            border: 2px solid #ccc;
            border-bottom: none;
        }

        .filters {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 20px;
            margin: 20px 0;
        }

        .statistics-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .statistics-table th,
        .statistics-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
        }

        .statistics-table th {
            background-color: #f4f4f4;
        }

        .table-wrapper {
            overflow-x: auto;
        }

        .source-container {
            margin-top: 20px;
            padding: 10px;
            background-color: #f1f1f1;
            font-size: 14px;
            border-radius: 5px;
        }

        .source-container strong {
            font-weight: bold;
        }
    </style>
</head>
<body>

    <!-- ğŸ”¹ í—¤ë” ì¶”ê°€ -->
    <div id="header"></div>

    <div class="container">
        <!-- ğŸ”¹ ì¹´í…Œê³ ë¦¬ íƒ­ -->
        <div class="tabs" id="tabs"></div>
        <!-- ğŸ”¹ í•„í„° (ì—°ë„ ì„ íƒ / ì§€í‘œ ì„ íƒ) -->
        <div class="filters" id="filters"></div>

        <!-- ğŸ”¹ í†µê³„ í…Œì´ë¸” -->
        <div class="table-wrapper">
            <table class="statistics-table">
                <thead>
                    <tr id="table-header">
                        <th>Year</th>
                    </tr>
                </thead>
                <tbody id="statistics-body"></tbody>
            </table>
        </div>

        <!-- ğŸ”¹ ë°ì´í„° ì¶œì²˜ ì •ë³´ -->
        <div class="source-container" id="source-container">
            <div id="source-list"></div>
        </div>
    </div>

    <script>
        // ğŸ”¹ í—¤ë” ë¡œë“œ (header.html ë™ì  ë¶ˆëŸ¬ì˜¤ê¸°)
        fetch("header.html")
            .then(response => response.text())
            .then(data => {
                document.getElementById("header").innerHTML = data;
            })
            .catch(error => console.error("Error loading header:", error));

        // ğŸ”¹ URLì—ì„œ ì„ íƒëœ ì§€í‘œ ê°€ì ¸ì˜¤ê¸°
        const urlParams = new URLSearchParams(window.location.search);
        const selectedIndicator = urlParams.get("indicator");

        // ğŸ”¹ JSON ë°ì´í„° ë¡œë“œ (ì§€í‘œ ë°ì´í„°)
        fetch("k-indicator_data.json")
            .then(response => response.json())
            .then(data => {
                console.log("âœ… ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì„±ê³µ", data);

                // ğŸ”¹ ì—°ë„ ì •ë ¬ (ì˜¤ë¦„ì°¨ìˆœ)
                const years = Object.keys(data).sort((a, b) => a - b);
                const tabs = document.getElementById("tabs");
                const filters = document.getElementById("filters");
                const tableHeader = document.getElementById("table-header");
                const tableBody = document.getElementById("statistics-body");
                const sourceList = document.getElementById("source-list");

                // ğŸ”¹ ì¹´í…Œê³ ë¦¬ ë¶„ë¥˜ (ì¤‘ë³µ ì œê±°)
                const categories = [...new Set(
                    Object.values(data).flatMap(yearData =>
                        yearData.map(item => item.category_en)
                    )
                )];

                // ğŸ”¹ ê° ì¹´í…Œê³ ë¦¬ë³„ ì§€í‘œ ëª©ë¡ ì €ì¥
                const categoryItems = {};
                Object.values(data).forEach(yearData => {
                    yearData.forEach(item => {
                        if (!categoryItems[item.category_en]) {
                            categoryItems[item.category_en] = new Set();
                        }
                        categoryItems[item.category_en].add(item.name_en);
                    });
                });

                // ğŸ”¹ ì„ íƒí•œ ì§€í‘œê°€ í¬í•¨ëœ ì¹´í…Œê³ ë¦¬ ìë™ í™œì„±í™”
                let defaultCategory = categories[0];
                if (selectedIndicator) {
                    for (const category of categories) {
                        if (categoryItems[category].has(selectedIndicator)) {
                            defaultCategory = category;
                            break;
                        }
                    }
                }

                // ğŸ”¹ íƒ­ ìƒì„± (ì¹´í…Œê³ ë¦¬ë³„)
                categories.forEach(category => {
                    const tab = document.createElement("div");
                    tab.textContent = category;
                    tab.className = "tab";
                    tab.dataset.category = category;

                    tab.addEventListener("click", () => {
                        document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
                        tab.classList.add("active");
                        updateFilters(category);
                        updateTable(category, getSelectedItems(category), years[0], years[years.length - 1]);
                    });

                    tabs.appendChild(tab);
                });

                document.querySelector(`.tab[data-category="${defaultCategory}"]`).classList.add("active");

                // ğŸ”¹ í•„í„° ì—…ë°ì´íŠ¸ (ì—°ë„ & ì§€í‘œ ì„ íƒ)
                function updateFilters(category) {
                    filters.innerHTML = "";

                    const itemFilter = document.createElement("div");
                    itemFilter.innerHTML = `<label>Select Items:</label>`;

                    const checkboxGroup = document.createElement("div");

                    [...categoryItems[category]].forEach((item, index) => {
                        const checkbox = document.createElement("input");
                        checkbox.type = "checkbox";
                        checkbox.value = item;
                        
                        // âœ… ì„ íƒí•œ ì§€í‘œê°€ ìˆìœ¼ë©´ í•´ë‹¹ ì§€í‘œë§Œ ì²´í¬, ì—†ìœ¼ë©´ 4ê°œ ê¸°ë³¸ ì„ íƒ
                        checkbox.checked = selectedIndicator ? item === selectedIndicator : index < 4;

                        checkbox.addEventListener("change", () => {
                            updateTable(category, getSelectedItems(category), years[0], years[years.length - 1]);
                        });

                        const label = document.createElement("label");
                        label.appendChild(checkbox);
                        label.appendChild(document.createTextNode(item));

                        checkboxGroup.appendChild(label);
                    });

                    itemFilter.appendChild(checkboxGroup);
                    filters.appendChild(itemFilter);
                }

                // ğŸ”¹ ì„ íƒëœ ì•„ì´í…œ ê°€ì ¸ì˜¤ê¸°
                function getSelectedItems(category) {
                    return Array.from(filters.querySelectorAll("input[type='checkbox']:checked")).map(cb => cb.value);
                }

                // ğŸ”¹ í…Œì´ë¸” ì—…ë°ì´íŠ¸ (ì§€í‘œ & ì—°ë„ ë°˜ì˜)
                function updateTable(category, selectedItems, startYear, endYear) {
                    tableHeader.innerHTML = "<th>Year</th>";
                    tableBody.innerHTML = "";
                    sourceList.innerHTML = "";

                    // âœ… ì„ íƒí•œ ì§€í‘œê°€ ìˆìœ¼ë©´ í•´ë‹¹ ì§€í‘œë§Œ ì„ íƒ, ì—†ìœ¼ë©´ ê¸°ë³¸ 4ê°œ ì„ íƒ
                    let items = selectedItems.length ? selectedItems : [...categoryItems[category]].slice(0, 4);

                    items.forEach(item => {
                        tableHeader.innerHTML += `<th>${item}</th>`;
                    });

                    years.forEach(year => {
                        const row = document.createElement("tr");
                        row.innerHTML = `<td>${year}</td>`;

                        items.forEach(item => {
                            const dataEntry = data[year]?.find(entry => entry.name_en === item);
                            const value = dataEntry ? dataEntry.value : "-";
                            row.innerHTML += `<td>${value}</td>`;
                        });

                        tableBody.appendChild(row);
                    });
                }

                // âœ… K-Indicator í´ë¦­ ì‹œ ê¸°ë³¸ 4ê°œ ì„ íƒ & ì§€í‘œ ì„ íƒ ì‹œ í•´ë‹¹ ì§€í‘œë§Œ ì„ íƒ
                updateFilters(defaultCategory);
                updateTable(defaultCategory, selectedIndicator ? [selectedIndicator] : [...categoryItems[defaultCategory]].slice(0, 4));
            })
            .catch(error => console.error("âŒ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨", error));
    </script>
</body>
</html>
